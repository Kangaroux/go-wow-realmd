package main

import (
	"encoding/csv"
	"encoding/hex"
	"os"
	"testing"

	"github.com/stretchr/testify/assert"
)

func mustDecodeHex(s string) []byte {
	data, err := hex.DecodeString(s)
	if err != nil {
		panic(err)
	}
	return data
}

func hexToByteArray(s string, bigEndian bool) *ByteArray {
	return NewByteArray(mustDecodeHex(s), 0, bigEndian)
}

func loadTestData(path string) [][]string {
	f, err := os.Open(path)
	if err != nil {
		panic(err)
	}
	defer f.Close()

	rows, err := csv.NewReader(f).ReadAll()
	if err != nil {
		panic(err)
	}

	return rows
}

func Test_calcX(t *testing.T) {
	rows := loadTestData("test_data/calculate_x.csv")

	for _, row := range rows {
		username := row[0]
		password := row[1]
		salt := hexToByteArray(row[2], false)
		expected := hexToByteArray(row[3], false).BigInt()

		assert.Equal(t, expected, calcX(username, password, salt))
	}
}

func Test_passVerify(t *testing.T) {
	rows := loadTestData("test_data/calculate_verifier.csv")

	for _, row := range rows {
		username := row[0]
		password := row[1]
		salt := hexToByteArray(row[2], false)
		expected := hexToByteArray(row[3], false).BigInt()

		assert.Equal(t, expected, passVerify(username, password, salt))
	}
}

func Test_calcServerPublicKey(t *testing.T) {
	rows := loadTestData("test_data/calculate_server_public_key.csv")

	for _, row := range rows {
		verifier := hexToByteArray(row[0], false).BigInt()
		serverPrivateKey := hexToByteArray(row[1], false).BigInt()
		expected := hexToByteArray(row[2], false).BigInt()

		assert.Equal(t, expected, calcServerPublicKey(verifier, serverPrivateKey))
	}
}

func Test_calcClientSKey(t *testing.T) {
	rows := loadTestData("test_data/calculate_client_s.csv")

	for _, row := range rows {
		serverPublicKey := hexToByteArray(row[0], false).BigInt()
		clientPrivateKey := hexToByteArray(row[1], false).BigInt()
		x := hexToByteArray(row[2], false).BigInt()
		u := hexToByteArray(row[3], false).BigInt()
		expected := hexToByteArray(row[4], false)

		assert.Equal(t, expected, calcClientSKey(clientPrivateKey, serverPublicKey, x, u))
	}
}

func Test_calcServerSKey(t *testing.T) {
	rows := loadTestData("test_data/calculate_server_s.csv")

	for _, row := range rows {
		clientPublicKey := hexToByteArray(row[0], false).BigInt()
		serverPrivateKey := hexToByteArray(row[1], false).BigInt()
		verifier := hexToByteArray(row[2], false).BigInt()
		u := hexToByteArray(row[3], false).BigInt()
		expected := hexToByteArray(row[4], false)

		assert.Equal(t, expected, calcServerSKey(clientPublicKey, verifier, u, serverPrivateKey))
	}
}

func Test_calcU(t *testing.T) {
	rows := loadTestData("test_data/calculate_u.csv")

	for _, row := range rows {
		clientPublicKey := hexToByteArray(row[0], false).BigInt()
		serverPublicKey := hexToByteArray(row[1], false).BigInt()
		expected := hexToByteArray(row[2], false).BigInt()

		assert.Equal(t, expected, calcU(clientPublicKey, serverPublicKey))
	}
}

func Test_prepareInterleave(t *testing.T) {
	type testCase struct {
		S        []byte
		expected []byte
	}

	testCases := []testCase{
		{[]byte{0, 1}, []byte{}},
		{[]byte{0, 1, 2, 3}, []byte{2, 3}},
		{[]byte{1, 0, 0, 0}, []byte{1, 0, 0, 0}},
		{[]byte{0, 0, 0, 0}, []byte{}},
	}

	for _, tc := range testCases {
		S := NewByteArray(tc.S, 0, false)
		assert.Equal(t, tc.expected, prepareInterleave(S))
	}
}

func Test_calcInterleave(t *testing.T) {
	type testCase struct {
		S        string // Little endian hex
		expected string // big endian hex
	}

	// First 10 testCases from:
	// https://gtker.com/implementation-guide-for-the-world-of-warcraft-flavor-of-srp6/verification_values/calculate_u_values.txt
	testCases := []testCase{
		{"8F4CEBD60DFC34E5C007E51BD4F3A4FF2BC1D930E2D3EA770D8D3EEDFF2DCCFC", "EE144E1AE08DAC891AB63ABC42BF89738003343422E6B58131BEE4C3087A7027E55A7216D18D556C"},
		{"CCC1BDE07FC4FA3182DDEAAB036A88F78AD605AB0D8BFBF6F5EE8ED65CDE4F09", "2AA23706C3FC3517A4293E2D4944F567E220CC1A227359D70154E5FD3CEE973673130C4AFBAD9E6D"},
		{"A060B6AAEA7A49DD3733A873F63CD5BFDE60370E983D0FF1F27A598F3BA7E1C9", "D5B83EEB23C42E6772373D5B4F49C96AE585333AEC174451E90637D4BD87BDA603FE2EF342CA93A8"},
		{"9F7AAC49E50DC2ABCB5AD526A133DCE31A43EC0C4DA03F4AECFDAFE3DD78CDB0", "A4FEF4DEA9EECD581A895FDDD8179F47825CD2D5CDA5175979D09E9F55077FBC9481D7C6E0E44833"},
		{"8E6C7E1EA4E046CF0B69BA0EB06AFEAB5EFDEBB1CDBB4152CAD0320A468A8DA0", "7A7A9DCF799929B00743EDDA8826CC9D36A586CE941FE59D049EDD30CACBFB9ECE03AE990035C0D7"},
		{"B13DECA79BEBBFE3D0D0F256AD6B9BBDDE7D302143B8D9A936B72E52256DDC54", "01AD264FAD5FC243B978C91C7B0C50DD3563F0073588AF7713503AE41735918A53B04509A344A647"},
		{"AFDEA3AFCCDD64BB7A04E77E7D0DCBFBB6A47C529AE48B510A98CE0E2A474FB9", "7E3A8F2274E19E55640FE52F3E5DBECB459AC16B522ECF8AE96700F1B100E60812B3F55B5F3452E4"},
		{"CFEDA5D3EF9E614C523E2C0BAB0CBCE9684FCC2080ACAB4DEC8EBD4CA3377BDB", "396A7C22D20BBA2A281A88B62CB3C4CDF7B7C87A6DE25BAB27DF33439326C133F4C1215DCA7A5B90"},
		{"5BEC4CF49E4CFEFF9975B3664F7FC4CA3F943E5248EDDDB9C244410EDA80B2E2", "F506C5AD3F1526CF8FF8F82E8D983C8284118AD2B1C0CDB8FD8E11441D64E1F7F3ED02B8A8D37548"},
		{"9E97D6CE9B8A350CD0596DC4D9DC5DFEE9EEFB2BCA3DB43DBE088598759D5CC8", "B48FF686A5FA85E26279934F661DE0649B32946BAECD99B6807CE37D345D54B8381DEC13FF6FC77A"},
	}

	for _, tc := range testCases {
		S := hexToByteArray(tc.S, false)
		expected := hexToByteArray(tc.expected, true)
		assert.Equal(t, expected, calcInterleave(S))
	}
}

// func Test_calcServerSessionKey(t *testing.T) {
// 	type testCase struct {
// 		clientPublicKey  string // Little endian hex
// 		verifier         string // Little endian hex
// 		serverPrivateKey string // Little endian hex
// 		expected         string // Big endian hex
// 	}

// 	// First 10 testCases from:
// 	// https://gtker.com/implementation-guide-for-the-world-of-warcraft-flavor-of-srp6/verification_values/calculate_server_session_key.txt
// 	testCases := []testCase{
// 		{"C7D81EDFC1C1F7C32ABDF18C3BF039DF66D69EEDAE5DF8A9F91FAC1AAF2BE68F", "7E4F0EDDDCDEFA5AFEB69C1F45BAB5FBFCF2AE1BC817FAFF9B4EAAC0CDAC3A3D", "ACB4A4DCE69D63224F0BFFCAFDDF01BC71CBAB3A7CCEEA12002E5EB4CBA54F6A", "EF9DCF429DA6547F30765495C36191B48BA6C10E22784A88A1F00D79FB623FB6D43B414C772098C4"},
// 		// {"74F57AB12EEA7B719D7A9BD4FA7A0FCC2A078CC3A3F5DADF9BDF32BDDBBDD62D", "B84C67EC8F48EBBB50C6CB21849CED5589C417A9ABCEDFAF3DBFD9F5A9B98FAA", "D6D9BCA60539DCE30C3EDDEEF5CAF372BFFCAAC4240EDD9C8EF91E4AFA23C63A", "DE585D190F6D7A8DAE0E7B9EA703790A04A308A2D5C1F8A8474CABEED7DBBCCFF6D59AB014D0052F"},
// 		// {"D18CAADAE784FA3B5DF2EAB6971E2FC37207446F8A0A7DCF54FF1D84FE0E27CE", "5CAAD6C3B2CFCA18C28A229FF91D6B0AF89CBFFD9A07EC394CDC69F7BE7FCFB3", "FEBE0CCBEA1EF8DB805FC5A68FEDDB8E97C33DCE6EFD0DA353ACAC9447E9F3FE", "4849FA5550E46632B20523C1A4626AE010A73C366EA0F9B4BC252556E2E856DC108EDB583E4952F1"},
// 		// {"8D6DDF7ABAEAFEE0ED681FDDBBC4ECAB76BFE1EDDF8EDDDC65BEC6C680AFEC9A", "34CEBEABEAAF79DCC8C5FBB3BD1BCA122DDA4CCCFA9EB0DD9EABBE407CEEBC0C", "1E1DBB54A7D605FECBF1EFC6CCA73FAADBFD5FB8CC1A6F792FD8FFB3A3CA7C4A", "78D96436B5378D113ADB9F83933BB67B7BC4EB346975E266BB37AC4193F923F685559F13006608D8"},
// 		// {"BFADA18CBBCF4DDFAF220A4B477C2D4E025B36F8DCDF32E4E1A956B0141FBB0B", "DE1A1A1E80F280EBFB5B9D61AC96B3C77DA8D5E8E4BDDBD3553BA88D57A605AF", "DFCACD5BAC03D4ECB4A8E10BAE1CC5D614BE36CDF1F52868036EFEE8CE5B58C9", "89A3E91806B838C832C275D7D44ECA04C02967AA490D0D59F605D1C246098F5061696F68F9DFA8D8"},
// 		// {"80CCBD68E3C158CEA17A5BBEB51293DAE1CAEA8DA11ADCFCC17AC4EFFD0C2A44", "38E7DF25CA4FEA814DDC20B78EFFBEEB2BEDDC42AFA3855BFB64BCC8EF83F5B3", "20A6AD0E1D098A76B8FD8EEDFDACC2E50AEBEEF72921956C5CE2FC8BAE75B827", "B591C5CF0C0C2CBB0873D45E6CBB91114D34F30EA2C5D6783EB4CAA46A6AB6B9B54A752A44A2A8AD"},
// 		// {"A66BECDC1FF3AFFFF23CCF7F7AD44C8C58AB3C123FD0EEE8AC4CB23BA8D01BE2", "E9AF1ACADDFA9E1F0294AE53A9BFB2C7DDB1442587FACAB49F8A7CACFA4D3ACF", "CA2181E13EED7EFFFEEBFA54C2CE6EE0E534A4A82ED41ACF9A08AD4B8DB0CFAD", "62CCDC67D303E8DCAE267CB88C000DFDC51408422E33D3DDDCE51D103D63C9178C44185C99695A95"},
// 		// {"DEAFCEF029A98D53F9CAE8D2F6FFF7D6E50D6E11A35A0BCD2EDEBA1DDC76A59D", "9EEEBDBF87EB26D7554B1CEDFAD09A2DFB50ADCCB1ADBCC1ECBCCC7C2CFC6B5B", "82D0EE30C1BFFAF471FC6BFFE45EE82F92A44FE44CDD8F68BD69D9C85CDECFDB", "2B4D140447A30C83BC71AA78A61AC5F6607CA98E723680CA156D15B3A59040B64F0C8D188A5939C5"},
// 		// {"A6C3BBFFF81E431EAA4625B842EAAD2DB5CCE07BF8CECE767B2FAC7F8A33C1A1", "9BD7DBEF0CD4DFECD3CCABBE0CFF4BDF1AAB2FA71729E2C403D86307D56E43DA", "B01EC2F041F2E5A22BB1AC4B7AEADDD9F6A4B3711F00DAEBDBD9A9B4C6556BC6", "5729067114065FF7552EB4E3E85DA789E06A14D52F7C2D773BF164D2AE42C1083457134DD5049318"},
// 		// {"5EFCF3BDA858A4DF6B0E703A9D8DFBDC877D0B586C3E6DCE7DDECC5FD1DBBEAD", "6F689FC9179A2FCEDAD1E0FBAE9BF4B3786D19027C5BE32EFBADDD26CEDC72CC", "EAEFA0CE2D71E03ECA25D90FA4F6FBCDCCD2D88DBBE1D1B3EA6CBB9D8549F07F", "0014E866A52665054698BA8231813B50916EFD0BC42C3CC9FBAF7BF24AADCE73F63C7FEFAAE65CCD"},
// 	}

// 	for _, tc := range testCases {
// 		clientPublicKey := hexToByteArray(tc.clientPublicKey, false).BigInt()
// 		verifier := hexToByteArray(tc.verifier, false).BigInt()
// 		serverPrivateKey := hexToByteArray(tc.serverPrivateKey, false).BigInt()
// 		serverPublicKey := calcServerPublicKey(verifier, serverPrivateKey)
// 		fmt.Printf("B: %x\n", serverPublicKey.Bytes())
// 		expected := hexToByteArray(tc.expected, true).LittleEndian()
// 		fmt.Printf("expected: %x\n", expected.Bytes())
// 		assert.Equal(
// 			t,
// 			expected,
// 			calcServerSessionKey(clientPublicKey,
// 				serverPublicKey,
// 				verifier,
// 				serverPrivateKey,
// 			),
// 		)
// 	}
// }

// func Test_calcClientSessionKey(t *testing.T) {
// 	type testCase struct {
// 		username         string // Plaintext
// 		password         string // Plaintext
// 		clientPublicKey  string // Little endian hex
// 		clientPrivateKey string // Little endian hex
// 		serverPublicKey  string // Little endian hex
// 		salt             string // Big endian hex
// 		expected         string // Little endian hex
// 	}

// 	// First 10 testCases from:
// 	// https://gtker.com/implementation-guide-for-the-world-of-warcraft-flavor-of-srp6/verification_values/calculate_server_session_key.txt
// 	testCases := []testCase{
// 		{"JZsyczxJwDVDXswZ", "ihPe779qnoDix6i5", "42ABC7A7CA3AF505EFF560EBAFA6ECE1C8AE65395A17EB39B98CDFEE1F5FAAEB", "28817DEEDCFA4DF43A0BD9CAB95E72CCA4B2FEECFABEEEE5F40861D4903B407E", "AAD74ABDDEA3BCCE8E4C2E1C8BA05BBAEF1F3DC1B52AAB2A2AC6F390B1276ABD", "9BBEE762EBCCE595E76EF891CD1A7F6C54CC8B65E30CA7CD3375C49433E0E3F7", "80D3FB86282E6A900517CF226BC00D7A4BD1402102648A6C1404C634E21E0BF78D322CE5D1B9DBE5"},
// 		{"lbOhuFSWnkUvb85X", "3Oxrd5k3tVLp46Zy", "CEC2B6F8D7C8B0792DAA6252138FE3CFC9838D7CB6BD4DBA1E3ABE4C7AAD6B7B", "025CBCF2CE5C1CED1BE41D89AC2B7A8DCC323FA59D9E14CFA40B28A13598FF7C", "83A0BFC06AF6E0782AEECAA2E9C2C26FBB7C8FD9C15BB1CDE672D05A6D1A319D", "234AD29E312E3629EA8E85F9CFEEBD394FCDBB164E23E4F145F3E64BFC971EFF", "A5B07A94B65534D8BAF559405C8AA1384427BA4767F8F624F808B5E7890D39D40DEDBD6ECA2DEBFA"},
// 		{"sFHQ6aoh3wfJTXaN", "2pBFKAuEByNkWqXF", "41CE6F062B4771FE3BDA667F43D0D53E5720E7E7CE16EFA91D6ACC169E279CE3", "4FC2843DC720DD76BDD3167AABE8F1E4BA190D883BE52B92B3C85CB83CCA10AC", "7CBFC0F46A7D67CFAD7E781C20E68DDAE0A5D3F05B7D4B3C2B8140A25F3EAD7E", "AEC9AD986CDF54D3E5DB4EEAFF9B2E38AD7EE2948FCAB6C91CD2DD1B6F219E3F", "2D68257416E3D2317A9111CB9219C88E16EDBB803CDFC7F25552AB833A04E851DABAF1A5611EFBC9"},
// 		{"UgvbPPR1Pvd2SDkL", "DS1LSWujYSwmUhEO", "C8DA4FF25BFA0C5EFAEBC9B14B021AAD83A0A4A66AFA5C8FDDCA1A521A2D668C", "FCEBCF90D7FE0CEEA8FABB4625DF31BC63A6096A9ED88C883DFAA7A650EE3D24", "5811ECFCC8AE8DFBF88499F796ACCAE1CDBCCF1E6B2735687AB40DEBBC08FB7C", "9AE0DBBC0D5BBBF1F2BADFA9018E5EBE511BBE59D52AAEB4670BCEDC9297FE2F", "4453847EB907A70A5BBE222EE1C381D4A5C548E3E32447BA98A4AB7E4B53E1A49FDCB72B931B80F5"},
// 		{"ncFm33aGlxKcn0QY", "bCuSAmJFX4e9KYFS", "8C4CA8A45FA68AC36D15C76DCB3C7BDB83F5EDBB0E5AF71C2A3F100F2CE3FCCC", "D16FDD5C7BCDDF9FD0A4A87AC484E1717FC5A823433316FBEF7E7436EA228743", "AF7AAA32FF6264BABDA84B8AE2FA1D7AFCEEE8DFBE5F59FE555ED0DC081D0BAB", "A73EEE0106A7EA6D6D5E5D8FBD7BBC5DDDCEBB0B882BB7FA84F1AD92F9845A53", "273FF5D625CC096E734ED237802990A47322BC7911CC1512EC301036B835E9E094DD246E1CEE124D"},
// 		{"zrfts7MNEdmFJZwM", "Vp1dOwk2VnDLa62O", "39BFCCEAADCD3F2E2AACBC13FF684D3D9F44DAEDD6EDE5FBF43AAC1BDD4D1C1B", "C427678ACEF7ABB4A8B54E9D9F93644A42EECEFEDE1BFB27FC2F24768BADCA1F", "8FB989DDBC4F15A4304E1CEFA6FACC0CB6F43CFAFF785FB45194ED7BD1CDBB55", "AFE2C9F7F977EB1BFAACD56CFEE25C4D7D087B340EA2A0F3BA1C0F541D5808DB", "B9870CFE1BE23EFFDB4FA8FD747D18413EAF4223D2F91FE8CC011B49D50618EF332BF98BE10D5943"},
// 		{"ULOcMyaT7MXceser", "pFNs1qclpBKs6g1I", "3BB3A4FFDCD585E9CCA95BFFFB1CDB1ABEC31B4C1D199BDE585D0BACD9CEF60B", "ABFAEF249E6F411DCCEAEE7C8EFBBD2BA87AB6DE4A759B8DB5C5ED1097A2E8EB", "5EEFF6AF6FDFF390F462349D221AE880FE3FDDC2E7FCCAD4FCCD0FB916EE6580", "E7DBF2EAEF5FABC6D2DD426E63869AEBC57C7D14CBCCC7DDE3389F1EDE48CE59", "3E73FF08D7B7FF403B22C1610F3242B618F1BA1C616DBC6597C28E06415BD9F4C1371E003D7622C4"},
// 		{"RyNiasaTUVw23N6n", "2Bf8oLRL4JjAmK5u", "C82FDE9C1D7CC05A72BD9587CD9BC6D79CE59F842E2BD4E266EBC78FA2B3CAAA", "AE5EABA1EEE08FF8167B433BDFB0E0B9FDBEE5A81A54A9C6D84EBD60FB25ADC6", "8D3C0C195ABAFDBA5E3DDBDA6345F15BB66DB51442AB55326EBA643ECAB609C0", "6B901F8D6E7D35BDBFBD4D5E71DE6DBEF7E7C6B0C037ADBF2104EAD79D3FAFEA", "83A793F2C7641EE68A73B849669F315189BCB11E24B9959248F69C0F70AC4905B34F4A3E01BFAB66"},
// 		{"oPSHo1D79V4487EZ", "boKq0rP7JCPDlCSX", "B7EBA995F9FAEF59C70FB1A55DF0EACFDE696CD8CC06E7BCF3DB9ADCEF9FACDB", "37291BFBBB0BE359B3C382C3140DE2AEE6EADDAEC500C3EA27DA95D7C31AABCE", "9DDB55AF8FAFBACE02D3CEF11CFBCCE5E8AFAC4AC39BE7B12C2F8E8FC8308F7F", "F07EB4C97729F4FBABBB55BBEC20AF2FE5C8F8CADEEBE80EF03A12E53EC7B096", "87E9708A96C09013D6D63898BE7DFC0478E38F1CDCB04693BE5204610765EDC29C88F11A99541E79"},
// 		{"L8SniqtpIDdyLv4p", "nhzoSdKmN3KlRKy6", "0307CC3C23E5DC2AD282FEFDE44D66CDFAAE0C7D7E1ABCA57CE5088EC0D6BDBB", "86EDFF57605F29FAD7A4D0ADA12D11414016D6DE7CA03CA3FFE71D5BE480C5CF", "85B8295EE4EB11FF21AFF5C104C20E908BBBED31DD53F8ACFD8FE83EE2A12FEE", "ADCDBB0CE9CCDCDFCC43D24E330CCF758F98B2E37DD6BB5DC14FFFEB6F8E6BBB", "CA0AE27695468B71CB92E462E6DAE418405F19A8C82FB26EB500742E80951330D73AEA688CC0F00F"},
// 	}

// 	for _, tc := range testCases {
// 		clientPublicKey := hexToByteArray(tc.clientPublicKey, false).BigInt()
// 		clientPrivateKey := hexToByteArray(tc.clientPrivateKey, false).BigInt()
// 		serverPublicKey := hexToByteArray(tc.serverPublicKey, false).BigInt()
// 		salt := hexToByteArray(tc.salt, true)
// 		expected := hexToByteArray(tc.expected, false)
// 		assert.Equal(
// 			t,
// 			expected,
// 			calcClientSessionKey(tc.username,
// 				tc.password,
// 				serverPublicKey,
// 				clientPrivateKey,
// 				clientPublicKey,
// 				salt,
// 			),
// 		)
// 	}
// }
